<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CyberShield Sentinel - Adaptive Corporate Security Assessment</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { --primary: #2563eb; --primary-dark: #1d4ed8; --secondary: #8b5cf6; --accent: #ec4899; --success: #10b981; --warning: #f59e0b; --danger: #ef4444; --light: #f8fafc; --dark: #1e293b; }
        body { font-family: 'Inter', sans-serif; background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); min-height: 100vh; }
        .screen { display: none; opacity: 0; transition: opacity 0.5s ease-in-out; }
        .screen.active { display: flex; opacity: 1; }
        .card { background: white; border-radius: 1rem; box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1); border: 1px solid rgba(255, 255, 255, 0.5); }
        .btn { display: inline-flex; align-items: center; justify-content: center; padding: 0.75rem 1.5rem; border-radius: 0.75rem; font-weight: 600; transition: all 0.2s ease; cursor: pointer; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2); }
        .btn-secondary { background: white; color: var(--primary); border: 2px solid var(--primary); }
        .btn-secondary:hover { background: #f0f7ff; transform: translateY(-2px); }
        .progress-bar { height: 0.5rem; border-radius: 1rem; background: #e2e8f0; overflow: hidden; }
        .progress-fill { height: 100%; border-radius: 1rem; background: linear-gradient(90deg, var(--primary) 0%, var(--secondary) 100%); transition: width 0.5s ease; }
        .conversation-container { max-height: 400px; overflow-y: auto; padding: 1rem; background: #f8fafc; border-radius: 1rem; margin-bottom: 1.5rem; }
        .message { margin-bottom: 1rem; display: flex; }
        .message-bot { justify-content: flex-start; }
        .message-user { justify-content: flex-end; }
        .message-content { padding: 0.75rem 1rem; border-radius: 1rem; max-width: 80%; }
        .message-bot .message-content { background: white; border: 1px solid #e2e8f0; }
        .message-user .message-content { background: var(--primary); color: white; }
        .option-btn { display: inline-block; padding: 0.75rem 1.25rem; margin: 0.25rem; background: white; border: 2px solid #e2e8f0; border-radius: 0.75rem; cursor: pointer; transition: all 0.2s ease; font-weight: 500; }
        .option-btn:hover { background: #f1f5f9; border-color: #3b82f6; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15); }
        .status-badge { display: inline-block; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; text-transform: capitalize;}
        .status-completed { background-color: #dcfce7; color: #166534; }
        .status-pending { background-color: #ffedd5; color: #9a3412; }
        .status-in_progress { background-color: #dbeafe; color: #1e40af; }
        /* Viewport-safe height on mobile toolbars */
        :root { --vh: 1vh; }
        @media (hover: none) and (pointer: coarse) {
            :root { --vh: 1vh; } /* will be set by JS */
        }

        /* Chat layout helpers */
        .cs-card { display:flex; flex-direction:column; min-height: min(88vh, 100svh - 140px); }
        .cs-scroll { flex:1 1 auto; min-height:0; overflow:auto; }
        .cs-bottom { position:sticky; bottom:0; padding-top:.5rem; background:linear-gradient(180deg, rgba(255,255,255,0) 0%, #fff 40%); }
        .cs-inline { display:none; }
        .cs-inline.show { display:block; }

        /* Navbar improvements */
        .nav-pill { 
            padding: 0.5rem 0.75rem; 
            border-radius: 0.5rem; 
            font-size: 0.875rem; 
            font-weight: 500; 
            border: 1px solid transparent; 
        }
        .nav-pill:hover { 
            border-color: #dbeafe; 
            background-color: #eff6ff; 
        }
        .nav-pill.active { 
            border-color: #93c5fd; 
            background-color: #eff6ff; 
            color: #1d4ed8; 
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">
    <nav id="navbar" class="bg-white/90 backdrop-blur shadow-sm py-3 px-4 md:px-6 flex justify-between items-center hidden sticky top-0 z-30">
        <div class="flex items-center">
          <div class="w-10 h-10 rounded-lg bg-blue-600 flex items-center justify-center mr-3"><i class="fas fa-shield-alt text-white text-lg"></i></div>
          <h1 class="text-lg md:text-xl font-bold text-blue-600">CyberShield Sentinel</h1>
        </div>
      
        <div class="hidden md:flex items-center gap-2" id="nav-links">
          <button id="nav-home" class="nav-pill">Home</button>
          <button id="nav-assessments" class="nav-pill">Assessments</button>
          <button id="nav-reports" class="nav-pill">Reports</button>
          <button id="nav-admin" class="nav-pill hidden">Admin</button>
          <button id="nav-exit" class="nav-pill text-red-600 border-red-200 hover:bg-red-50 hidden">Exit</button>
        </div>
      
        <div class="flex items-center space-x-3">
          <span id="nav-user-name" class="text-gray-700 font-medium"></span>
          <button id="logout-btn" class="text-gray-600 hover:text-blue-600 flex items-center gap-1">
            <i class="fas fa-sign-out-alt"></i><span class="hidden md:inline">Logout</span>
          </button>
        </div>
    </nav>
      
    
    <main class="flex-1 flex items-center justify-center p-4 py-8">
        <!-- Hero / Start -->
        <section id="pre-hero" class="screen active w-full max-w-2xl mx-auto flex-col justify-center">
            <div class="card p-8 text-center">
            <div class="w-16 h-16 mx-auto mb-4 rounded-2xl bg-blue-100 flex items-center justify-center">
                <i class="fa fa-shield-alt text-blue-600 text-2xl"></i>
            </div>
            <h1 class="text-3xl font-extrabold mb-2">Cyber Shield™</h1>
            <p class="text-gray-600 mb-6">AAAS – Assessment as a Service</p>
            <p class="text-sm text-gray-500 mb-8">by Cyber Posture LLC</p>
            <button id="hero-start" class="btn btn-primary">Start Assessment</button>
            </div>
        </section>
        
        <!-- Consent -->
        <section id="pre-consent" class="screen hidden w-full max-w-3xl mx-auto flex-col justify-center">
            <div class="card p-8">
            <h2 class="text-2xl font-bold mb-4">Before We Begin</h2>
            <ul class="space-y-3 text-gray-700 mb-6">
                <li><b>We assess behavior — not identity.</b> No sensitive PII required.</li>
                <li><b>Data Usage & Privacy.</b> GDPR/CCPA aligned. Anonymized analytics improve risk models.</li>
                <li><b>Disclaimer.</b> Educational tool; not a formal technical audit.</li>
            </ul>
            <label class="flex items-start gap-3 mb-6">
                <input id="consent-check" type="checkbox" class="mt-1">
                <span>I have read and agree to the terms.</span>
            </label>
            <div class="flex justify-end gap-2">
                <button class="btn btn-secondary" id="consent-back">Back</button>
                <button class="btn btn-primary" id="consent-next" disabled>Proceed</button>
            </div>
            </div>
        </section>
        
        <!-- Track selection -->
        <section id="pre-track" class="screen hidden w-full max-w-4xl mx-auto flex-col justify-center">
            <div class="card p-8">
            <h2 class="text-3xl font-bold text-center mb-2">Choose Your Assessment Track</h2>
            <p class="text-gray-600 text-center mb-6">Select your context to personalize the 10-minute assessment.</p>
            <div class="grid md:grid-cols-2 gap-4">
                <button id="track-personal" class="p-5 rounded-2xl border hover:border-blue-300 bg-blue-50 text-left">
                <div class="flex items-center gap-3 mb-2"><i class="fa fa-user-shield text-blue-600"></i><b>Personal Track</b></div>
                <p class="text-gray-600 text-sm">Home IoT, cloud storage, smart devices, data habits.</p>
                </button>
                <button id="track-corporate" class="p-5 rounded-2xl border hover:border-purple-300 bg-purple-50 text-left">
                <div class="flex items-center gap-3 mb-2"><i class="fa fa-building-shield text-purple-600"></i><b>Corporate Track</b></div>
                <p class="text-gray-600 text-sm">Workplace tools, policy, corporate data handling.</p>
                </button>
            </div>
            <div class="flex justify-end mt-6">
                <button class="btn btn-secondary" id="track-back">Back</button>
            </div>
            </div>
        </section>
        
        <div id="login-screen" class="screen hidden w-full max-w-md mx-auto flex-col justify-center">
            <div class="card p-8">
              <div class="text-center mb-8">
                <h2 class="text-2xl font-bold mb-2">Personalization & Tracking</h2>
                <p class="text-gray-600">Enter details to sign in and personalize your experience.</p>
              </div>
              <div id="login-error" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4 hidden">
                <strong class="font-bold">Login Failed!</strong> <span id="login-error-message"></span>
              </div>
              <div class="mb-4"><input type="email" id="login-email" class="w-full p-3 border rounded-lg" placeholder="Email or Employee ID" required></div>
              <div class="mb-4"><input type="password" id="login-password" class="w-full p-3 border rounded-lg" placeholder="Password" required></div>
              <div class="mb-6"><input type="text" id="login-firstname" class="w-full p-3 border rounded-lg" placeholder="First Name (optional)"></div>
              <button id="login-btn" class="btn btn-primary w-full">Continue</button>
            </div>
        </div>
          

        <div id="admin-dashboard" class="screen w-full max-w-6xl mx-auto flex-col">
            <div class="card p-8">
                <h1 class="text-3xl font-bold text-gray-800 mb-8">Admin Dashboard</h1>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="p-6 bg-blue-50 rounded-lg"><h3 class="font-bold text-lg mb-2">Total Employees</h3><p class="text-3xl font-bold text-blue-600" id="total-employees">--</p></div>
                    <div class="p-6 bg-orange-50 rounded-lg"><h3 class="font-bold text-lg mb-2">Pending Assessments</h3><p class="text-3xl font-bold text-orange-600" id="pending-assessments">--</p></div>
                    <div class="p-6 bg-green-50 rounded-lg"><h3 class="font-bold text-lg mb-2">Avg. Security Score</h3><p class="text-3xl font-bold text-green-600" id="avg-security-score">--%</p></div>
                </div>
                <div class="mb-8">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Assign New Assessment</h2>
                    <div class="bg-gray-50 p-6 rounded-xl">
                        <div id="assign-success" class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative mb-4 hidden" role="alert">Assessment assigned successfully!</div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div><label class="block text-gray-700 font-medium mb-2">Select Employee</label><select id="assign-employee" class="w-full p-3 border border-gray-300 rounded-lg"><option value="">-- Loading Employees --</option></select></div>
                            <div><label class="block text-gray-700 font-medium mb-2">Due Date</label><input type="date" id="due-date" class="w-full p-3 border border-gray-300 rounded-lg"></div>
                        </div>
                        <button id="assign-assessment-btn" class="btn btn-primary"><i class="fas fa-tasks mr-2"></i> Assign Assessment</button>
                    </div>
                </div>
                <div>
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Employee Risk Overview</h2>
                    <div class="bg-gray-50 p-6 rounded-xl overflow-x-auto">
                        <table class="w-full"><thead class="border-b"><tr class="text-left"><th class="p-3 font-medium">Employee</th><th class="p-3 font-medium">Department</th><th class="p-3 font-medium">Last Score</th><th class="p-3 font-medium">Status</th></tr></thead><tbody id="employee-table-body"></tbody></table>
                    </div>
                </div>
            </div>
        </div>

        <div id="employee-dashboard" class="screen w-full max-w-4xl mx-auto flex-col">
            <div class="card p-8">
                <h1 class="text-3xl font-bold text-gray-800 mb-2">Welcome, <span id="employee-name"></span></h1>
                <p class="text-gray-600 mb-8">Department: <span id="employee-department"></span></p>
                <div class="mb-8">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Your Assigned Assessments</h2>
                    <div class="space-y-4" id="assigned-assessments-list"></div>
                </div>
                <div>
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Your Past Reports</h2>
                    <div class="space-y-4" id="past-reports-list"></div>
                </div>
            </div>
        </div>

        <div id="conversation-screen" class="screen w-full max-w-2xl mx-auto flex-col justify-center">
            <div class="card p-0 cs-card">
              <!-- header row inside the card -->
              <div class="flex items-center justify-between px-6 pt-5">
                <h2 class="text-xl font-bold text-gray-800">Security Assessment</h2>
                <div class="w-40">
                  <div class="text-xs text-gray-600 text-right mb-1"><span id="progress-percent">0%</span> Complete</div>
                  <div class="progress-bar"><div id="progress-fill" class="progress-fill" style="width: 0%"></div></div>
                </div>
              </div>
          
              <!-- inline notice (in-UI messages like “Exited…”) -->
              <div id="cs-inline" class="cs-inline px-6 mt-3">
                <div id="cs-inline-box" class="rounded-lg border border-blue-200 bg-blue-50 text-blue-800 px-4 py-3 text-sm"></div>
              </div>
          
              <!-- scrollable conversation area -->
              <div class="conversation-container cs-scroll px-6" id="conversation-container"></div>
          
              <!-- options + sticky bottom controls -->
              <div class="cs-bottom px-6 pb-5">
                <div id="options-container" class="flex flex-wrap justify-center mb-3"></div>
                <div class="flex items-center justify-between gap-2">
                  <div class="flex items-center gap-2">
                    <button id="btn-back" class="btn btn-secondary"><i class="fa fa-chevron-left mr-1"></i>Back</button>
                    <button id="btn-skip" class="btn btn-secondary">Skip</button>
                  </div>
                  <div class="flex items-center gap-2">
                    <button id="btn-exit" class="btn bg-red-50 text-red-600 border border-red-200 hover:bg-red-100">Exit</button>
                    <button id="btn-next" class="btn btn-primary">Next<i class="fa fa-chevron-right ml-1"></i></button>
                  </div>
                </div>
              </div>
            </div>
        </div>
          
        <div id="report-screen" class="screen w-full max-w-4xl mx-auto flex-col">
            <div class="card p-8">
                <div class="text-center mb-8">
                    <h1 class="text-3xl font-bold text-gray-800 mb-2">Your Security Assessment Report</h1>
                    <p class="text-gray-600">Generated on <span id="report-date"></span> for <span id="report-user-name"></span></p>
                </div>
        
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-blue-50 p-6 rounded-xl text-center flex flex-col justify-center">
                        <p class="text-6xl font-bold text-blue-700" id="report-score">--%</p>
                        <h3 class="font-semibold text-lg mb-1">Overall Score</h3>
                        <div id="report-risk-level" class="font-bold text-lg"></div>
                    </div>
                    <div class="md:col-span-2 bg-gray-50 p-6 rounded-xl">
                        <h3 class="font-semibold text-lg mb-4">Category Scores</h3>
                        <div id="report-category-scores" class="space-y-4"></div>
                    </div>
                </div>
        
                <div class="mb-8">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Behavioral Pattern Analysis</h2>
                    <div id="report-behavioral-patterns" class="bg-gray-50 p-6 rounded-xl grid grid-cols-1 md:grid-cols-2 gap-4">
                        </div>
                </div>
        
                <div class="mb-8">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Actionable Recommendations</h2>
                    <div id="report-recommendations" class="space-y-3"></div>
                </div>
        
                <div class="mb-8">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">What You're Doing Well</h2>
                    <div class="bg-green-50 p-6 rounded-xl">
                        <ul id="report-strengths" class="list-disc list-inside space-y-2 text-green-800"></ul>
                    </div>
                </div>
        
                <div class="text-center">
                    <button id="back-to-dashboard-btn" class="btn btn-primary"><i class="fas fa-arrow-left mr-2"></i> Back to Dashboard</button>
                </div>
            </div>
        </div>
        
    </main>
    <!-- Exit confirm modal -->
    <div id="exit-modal" class="fixed inset-0 hidden items-center justify-center bg-black/40 z-40">
        <div class="bg-white rounded-xl shadow-xl border border-gray-200 w-[92vw] max-w-md p-5">
        <h3 class="text-lg font-semibold text-gray-900 mb-1">Exit assessment?</h3>
        <p class="text-sm text-gray-600 mb-4">Your progress will be saved. You can resume anytime from your dashboard.</p>
        <div class="flex justify-end gap-2">
            <button id="exit-cancel" class="btn btn-secondary">Cancel</button>
            <button id="exit-confirm" class="btn bg-red-600 text-white">Exit</button>
        </div>
        </div>
    </div>
  
    </body>
    <script>
        const state = { currentScreen: 'login-screen', user: null, token: null, currentSessionId: null, totalQuestions: 10 };
        const API_BASE_URL = 'http://localhost:5000/api';
        // viewport-safe height for mobile browsers
        function setVH() { document.documentElement.style.setProperty('--vh', `${window.innerHeight * 0.01}px`); }
        window.addEventListener('resize', setVH); setVH();

        const ui = {
            screens: document.querySelectorAll('.screen'),
            navbar: document.getElementById('navbar'),
            navUserName: document.getElementById('nav-user-name'),
            login: { screen: document.getElementById('login-screen'), emailInput: document.getElementById('login-email'), passwordInput: document.getElementById('login-password'), loginBtn: document.getElementById('login-btn'), error: document.getElementById('login-error'), errorMessage: document.getElementById('login-error-message'), },
            admin: { screen: document.getElementById('admin-dashboard'), totalEmployees: document.getElementById('total-employees'), pendingAssessments: document.getElementById('pending-assessments'), avgScore: document.getElementById('avg-security-score'), assignEmployeeSelect: document.getElementById('assign-employee'), dueDateInput: document.getElementById('due-date'), assignBtn: document.getElementById('assign-assessment-btn'), employeeTableBody: document.getElementById('employee-table-body'), assignSuccess: document.getElementById('assign-success'), },
            employee: { screen: document.getElementById('employee-dashboard'), name: document.getElementById('employee-name'), department: document.getElementById('employee-department'), assignedList: document.getElementById('assigned-assessments-list'), pastReportsList: document.getElementById('past-reports-list'), },
            assessment: { screen: document.getElementById('conversation-screen'), conversationContainer: document.getElementById('conversation-container'), optionsContainer: document.getElementById('options-container'), progressPercent: document.getElementById('progress-percent'), progressFill: document.getElementById('progress-fill'), },
            logoutBtn: document.getElementById('logout-btn'),
        };
        function showInline(msg, tone='info') {
        const box = document.getElementById('cs-inline-box');
        const wrap = document.getElementById('cs-inline');
        const palette = {
            info:  { bg:'bg-blue-50',  border:'border-blue-200', text:'text-blue-800' },
            warn:  { bg:'bg-yellow-50',border:'border-yellow-200',text:'text-yellow-800' },
            danger:{ bg:'bg-red-50',   border:'border-red-200',   text:'text-red-800' },
            good:  { bg:'bg-green-50', border:'border-green-200', text:'text-green-800' }
        }[tone] || { bg:'bg-blue-50', border:'border-blue-200', text:'text-blue-800' };

        box.className = `rounded-lg ${palette.border} ${palette.bg} ${palette.text} px-4 py-3 text-sm`;
        box.textContent = msg;
        wrap.classList.add('show');
        }

        function setNavbarActive(id) {
        document.querySelectorAll('#nav-links .nav-pill').forEach(b=>b.classList.remove('active'));
        const el = document.getElementById(id); if (el) el.classList.add('active');
        }

        function setNavbarRoleVisibility() {
        // show Admin link only for admins
        const adminBtn = document.getElementById('nav-admin');
        if (state.user?.role === 'admin') adminBtn.classList.remove('hidden');
        else adminBtn.classList.add('hidden');
        }

        function setExitVisible(isVisible) {
        const exitTop = document.getElementById('nav-exit');
        const exitBottom = document.getElementById('btn-exit');
        [exitTop, exitBottom].forEach(el => el?.classList.toggle('hidden', !isVisible));
        }

        async function apiCall(endpoint, method = 'GET', body = null) {
            const headers = { 'Content-Type': 'application/json' };
            if (state.token) headers['Authorization'] = `Bearer ${state.token}`;
            const options = { method, headers, body: body ? JSON.stringify(body) : null };
            const response = await fetch(`${API_BASE_URL}${endpoint}`, options);
            const data = await response.json();
            if (!response.ok) throw new Error(data.error || `HTTP error! status: ${response.status}`);
            return data;
        }
        
        function showScreen(screenId) {
            // activate target
            ui.screens.forEach(s => s.classList.remove('active'));
            const target = document.getElementById(screenId);
            if (target) target.classList.add('active');
            state.currentScreen = screenId;

            // hide navbar on pre-login screens
            const preScreens = ['pre-hero', 'pre-consent', 'pre-track', 'login-screen'];
            const hideNavbar = preScreens.includes(screenId);
            if (ui.navbar) ui.navbar.classList.toggle('hidden', hideNavbar);

            // nav pill active state
            if (screenId === 'admin-dashboard')       setNavbarActive('nav-admin');
            else if (screenId === 'employee-dashboard') setNavbarActive('nav-assessments');
            else if (screenId === 'report-screen')      setNavbarActive('nav-reports');
            else                                        setNavbarActive('nav-home');

            // show Exit buttons only during assessment
            setExitVisible(screenId === 'conversation-screen');
        }

        // Hero
        document.getElementById('hero-start').addEventListener('click', ()=> showScreen('pre-consent'));

        // Consent
        const consentCheck = document.getElementById('consent-check');
        const consentNext = document.getElementById('consent-next');
        consentCheck.addEventListener('change', ()=> consentNext.disabled = !consentCheck.checked);
        document.getElementById('consent-back').addEventListener('click', ()=> showScreen('pre-hero'));
        consentNext.addEventListener('click', ()=> showScreen('pre-track'));

        // Track selection
        let selectedTrack = null;
        document.getElementById('track-back').addEventListener('click', ()=> showScreen('pre-consent'));
        document.getElementById('track-personal').addEventListener('click', ()=> { selectedTrack='personal'; showScreen('login-screen'); });
        document.getElementById('track-corporate').addEventListener('click', ()=> { selectedTrack='corporate'; showScreen('login-screen'); });


        // Modify handleLogin to capture firstName & track
        async function handleLogin() {
            const email = ui.login.emailInput.value.trim();
            const password = ui.login.passwordInput.value;
            const firstName = document.getElementById('login-firstname').value.trim();
            ui.login.error.classList.add('hidden');

            if (!email || !password) {
                ui.login.errorMessage.textContent = 'Please enter both email and password.';
                ui.login.error.classList.remove('hidden'); return;
            }

            try {
                const data = await apiCall('/auth/login', 'POST', { email, password });
                state.token = data.token; state.user = data.user;
                if (firstName) state.user.firstName = firstName;
                if (selectedTrack) state.user.track = selectedTrack;

                ui.navUserName.textContent = state.user.name || firstName || email;
                setNavbarRoleVisibility();
                if (state.user.role === 'admin') { renderAdminDashboard(); showScreen('admin-dashboard'); }
                else { renderEmployeeDashboard(); showScreen('employee-dashboard'); }
            } catch (err) {
                ui.login.errorMessage.textContent = err.message;
                ui.login.error.classList.remove('hidden');
            }
        }

        
        function handleLogout() {
            state.token = null; state.user = null;
            ui.login.emailInput.value = ''; ui.login.passwordInput.value = '';
            showScreen('login-screen');
        }

        async function renderAdminDashboard() {
            try {
                const [dashboardData, employees] = await Promise.all([ apiCall('/admin/dashboard'), apiCall('/admin/employees') ]);
                ui.admin.totalEmployees.textContent = dashboardData.stats.totalEmployees;
                ui.admin.pendingAssessments.textContent = dashboardData.stats.pendingAssessments;
                ui.admin.avgScore.textContent = `${dashboardData.stats.avgSecurityScore}%`;
                ui.admin.employeeTableBody.innerHTML = employees.map(emp => `
                    <tr class="border-b hover:bg-gray-50 text-sm">
                        <td class="p-3">${emp.name}</td>
                        <td class="p-3">${emp.department}</td>
                        <td class="p-3">${emp.last_score ? emp.last_score + '%' : 'N/A'}</td>
                        <td class="p-3"><span class="status-badge status-${(emp.assignment_status || 'completed').replace(' ', '_')}">${emp.assignment_status || 'Completed'}</span></td>
                    </tr>`).join('');
                ui.admin.assignEmployeeSelect.innerHTML = '<option value="">-- Select Employee --</option>' + employees.map(emp => `<option value="${emp.email}">${emp.name} (${emp.department})</option>`).join('');
            } catch (error) { console.error('Failed to load admin dashboard:', error); alert('Could not load admin data.'); }
        }

        async function handleAssignAssessment() {
            const user_id = ui.admin.assignEmployeeSelect.value;
            const due_date = ui.admin.dueDateInput.value;
            if (!user_id || !due_date) return alert('Please select an employee and a due date.');
            try {
                await apiCall('/assign', 'POST', { user_id, due_date });
                ui.admin.assignSuccess.classList.remove('hidden');
                setTimeout(() => ui.admin.assignSuccess.classList.add('hidden'), 3000);
                renderAdminDashboard();
            } catch (error) { alert(`Failed to assign assessment: ${error.message}`); }
        }

        async function renderEmployeeDashboard() {
            ui.employee.name.textContent = state.user.name;
            ui.employee.department.textContent = state.user.department;
            try {
                const data = await apiCall('/employee/dashboard');
                ui.employee.assignedList.innerHTML = data.assignments.filter(a => a.status === 'pending' || a.status === 'in_progress').map(a => {
                    const isPending = a.status === 'pending';
                    return `
                    <div class="bg-blue-50 p-4 rounded-lg border-l-4 border-blue-500 flex justify-between items-center">
                        <div>
                            <h4 class="font-semibold">${a.assessment_type} Assessment</h4>
                            <p class="text-sm text-gray-600">Due: ${new Date(a.due_date).toLocaleDateString()} <span class="status-badge status-${a.status.replace(' ', '_')}">${a.status}</span></p>
                        </div>
                        <button class="btn ${isPending ? 'btn-primary' : 'btn-secondary'} btn-sm start-assessment-btn" data-assignment-id="${a.assignment_id}">
                            ${isPending ? 'Start Now' : 'Resume'}
                        </button>
                    </div>`;
                }).join('') || '<p class="text-gray-500">No pending assessments. Great job!</p>';
                
                ui.employee.pastReportsList.innerHTML = data.assessments.filter(a => a.status === 'completed' && a.overall_score != null).map(a => `
                    <div class="bg-gray-50 p-4 rounded-lg flex justify-between items-center">
                        <div>
                            <h4 class="font-semibold">Assessment Report</h4>
                            <p class="text-sm text-gray-600">Completed: ${new Date(a.completed_date).toLocaleDateString()}</p>
                        </div>
                        <button class="btn btn-secondary btn-sm view-report-btn" data-session-id="${a.session_id}">
                            View Report (${a.overall_score}%)
                        </button>
                    </div>`).join('') || '<p class="text-gray-500">No past reports found.</p>';
            } catch (error) { alert(`Failed to load your dashboard: ${error.message}`); }
        }
                
        let questionHistory = [];
        async function startAssessment(assignmentId) {
            if (!assignmentId) {
                alert('Invalid assignment selected.');
                return;
            }
            
            try {
                console.log('Starting assessment for assignment:', assignmentId);
                
                const data = await apiCall('/assessments/start', 'POST', { assignmentId });
                
                console.log('API Response:', data);
                
                // Validate API response
                if (!data.success) {
                    throw new Error('API returned success: false');
                }
                
                if (!data.session_id) {
                    throw new Error('No session ID returned from API');
                }
                
                if (!data.current_question) {
                    throw new Error('No current question returned from API');
                }
                
                if (!data.current_question.id) {
                    throw new Error('Question is missing ID field');
                }
                
                // All validations passed - proceed
                state.currentSessionId = data.session_id;
                questionHistory = [data.current_question];
                
                renderConversation();
                document.getElementById('cs-inline')?.classList.remove('show');
                setExitVisible(true);

                showScreen('conversation-screen'); 
                
            } catch (error) {
                console.error('Assessment start error:', error);
                alert(`Could not start assessment: ${error.message}`);
            }
        }
        
        function renderConversation() {
            const currentQuestion = questionHistory[questionHistory.length - 1];
            ui.assessment.conversationContainer.innerHTML = questionHistory.map(q => `
                <div class="message message-bot"><div class="message-content"><p>${q.text}</p></div></div>
                ${q.userAnswer ? `<div class="message message-user"><div class="message-content"><p>${q.userAnswer}</p></div></div>` : ''}`
            ).join('');
            ui.assessment.optionsContainer.innerHTML = currentQuestion.options.map(option => `<div class="option-btn" data-answer="${option}">${option}</div>`).join('');
            const progress = Math.min(100, Math.round(((questionHistory.length - 1) / state.totalQuestions) * 100));
            ui.assessment.progressPercent.textContent = `${progress}%`;
            ui.assessment.progressFill.style.width = `${progress}%`;
            ui.assessment.conversationContainer.scrollTop = ui.assessment.conversationContainer.scrollHeight;
        }

        async function handleOptionSelect(e) {
            if (!e.target.matches('.option-btn')) return;
            const answer = e.target.dataset.answer;
            const currentQuestion = questionHistory[questionHistory.length - 1];
            currentQuestion.userAnswer = answer;
            try {
                const data = await apiCall(`/assessments/${state.currentSessionId}/answer`, 'POST', { 
                    questionId: currentQuestion.id,
                    answer_text: answer 
                });
                if (data.is_complete) {
                    showInline('Assessment complete! Your report is now available in your dashboard.', 'good');
                    await renderEmployeeDashboard();
                    showScreen('employee-dashboard');
                    return;
                } else {
                    questionHistory.push(data.next_question);
                    renderConversation();
                }
            } catch (error) { alert(`Error submitting answer: ${error.message}`); }
        }
        const uiReport = {
            screen: document.getElementById('report-screen'),
            date: document.getElementById('report-date'),
            score: document.getElementById('report-score'),
            summary: document.getElementById('report-summary'),
            backBtn: document.getElementById('back-to-dashboard-btn'),
        };

        async function viewReport(sessionId) {
            if (!sessionId) return;
            try {
                const data = await apiCall(`/assessments/${sessionId}/report`);
                const report = data.report;

                // --- Populate Header ---
                document.getElementById('report-date').textContent = new Date(report.created_at).toLocaleDateString();
                document.getElementById('report-user-name').textContent = report.user_name;

                // --- Populate Overall Score & Risk ---
                const scoreEl = document.getElementById('report-score');
                const riskEl = document.getElementById('report-risk-level');
                scoreEl.textContent = `${report.overall_score}%`;
                if (report.overall_score >= 80) { riskEl.textContent = 'Low Risk'; riskEl.className = 'font-bold text-lg text-green-600'; }
                else if (report.overall_score >= 50) { riskEl.textContent = 'Moderate Risk'; riskEl.className = 'font-bold text-lg text-yellow-600'; }
                else { riskEl.textContent = 'High Risk'; riskEl.className = 'font-bold text-lg text-red-600'; }

                // --- Populate Category Scores ---
                const categoryScoresContainer = document.getElementById('report-category-scores');
                categoryScoresContainer.innerHTML = Object.entries(report.category_scores).map(([name, score]) => `
                    <div>
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-gray-600 capitalize">${name}</span><span class="font-semibold">${score}%</span>
                        </div>
                        <div class="progress-bar"><div class="progress-fill" style="width: ${score}%"></div></div>
                    </div>
                `).join('');

                // --- Populate Behavioral Patterns ---
                const patternsContainer = document.getElementById('report-behavioral-patterns');
                patternsContainer.innerHTML = Object.keys(report.behavioral_patterns).length > 0 
                    ? Object.entries(report.behavioral_patterns).map(([name, value]) => `
                        <div class="flex items-center"><i class="fas fa-exclamation-triangle text-yellow-500 mr-3"></i>
                            <div><div class="font-semibold capitalize">${name.replace(/([A-Z])/g, ' $1')}</div><div class="text-sm text-gray-500">Vulnerability detected</div></div>
                        </div>`).join('')
                    : `<p class="text-gray-500 col-span-2">No significant negative behavioral patterns were detected.</p>`;

                // --- Populate Recommendations ---
                const recommendationsContainer = document.getElementById('report-recommendations');
                recommendationsContainer.innerHTML = report.recommendations.map(rec => {
                    let color = 'blue';
                    if (rec.priority === 'critical') color = 'red';
                    if (rec.priority === 'important') color = 'yellow';
                    return `<div class="p-4 rounded-lg border-l-4 border-${color}-500 bg-${color}-50">
                                <div class="font-semibold capitalize">${rec.priority}</div>
                                <p class="text-gray-700">${rec.text}</p>
                            </div>`;
                }).join('');

                // --- Populate Strengths ---
                const strengthsContainer = document.getElementById('report-strengths');
                strengthsContainer.innerHTML = report.strengths.map(s => `<li>${s}</li>`).join('');

                showScreen('report-screen');
            } catch (error) {
                alert(`Could not load report: ${error.message}`);
            }
        }
        
        function initializeApp() {
            ui.login.loginBtn.addEventListener('click', handleLogin);
            ui.logoutBtn.addEventListener('click', handleLogout);
            ui.admin.assignBtn.addEventListener('click', handleAssignAssessment);
            ui.assessment.optionsContainer.addEventListener('click', handleOptionSelect);
            uiReport.backBtn.addEventListener('click', () => {
                renderEmployeeDashboard(); // Refresh dashboard
                showScreen('employee-dashboard');
            });

            document.body.addEventListener('click', (e) => {
                if (e.target.matches('.start-assessment-btn')) {
                    const assignmentId = e.target.dataset.assignmentId;
                    startAssessment(assignmentId);
                }
                if (e.target.matches('.view-report-btn')) {
                    const sessionId = e.target.dataset.sessionId;
                    viewReport(sessionId);
                }
            });
        }
        // Exit modal handlers
        const exitModal = document.getElementById('exit-modal');
        document.getElementById('btn-exit').addEventListener('click', ()=> exitModal.classList.remove('hidden'));
        document.getElementById('nav-exit').addEventListener('click', ()=> exitModal.classList.remove('hidden'));
        document.getElementById('exit-cancel').addEventListener('click', ()=> exitModal.classList.add('hidden'));
        document.getElementById('exit-confirm').addEventListener('click', async ()=>{
        exitModal.classList.add('hidden');
        // OPTIONAL: persist exit/paused to backend
        // await apiCall('/assessments/exit', 'POST', { session_id: state.currentSessionId });
        showInline('You exited the assessment. Progress saved — resume any time from your dashboard.', 'info');
        // Go back to employee dashboard
        await renderEmployeeDashboard();
        showScreen('employee-dashboard');
        });

        // Top nav pill routes
        document.getElementById('nav-home').addEventListener('click', ()=> {
        if (state.user?.role === 'admin') { renderAdminDashboard(); showScreen('admin-dashboard'); }
        else { renderEmployeeDashboard(); showScreen('employee-dashboard'); }
        });
        document.getElementById('nav-assessments').addEventListener('click', ()=> { renderEmployeeDashboard(); showScreen('employee-dashboard'); });
        document.getElementById('nav-reports').addEventListener('click', ()=> { renderEmployeeDashboard(); showScreen('employee-dashboard'); }); // or a reports screen if you add one
        document.getElementById('nav-admin').addEventListener('click', ()=> { renderAdminDashboard(); showScreen('admin-dashboard'); });
       
        initializeApp();
    </script>
</body>
</html>